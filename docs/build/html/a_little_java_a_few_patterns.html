<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>《A Little Java, A Few Patterns》笔记 &mdash; 《A Little Java, A Few Patterns》笔记 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="《A Little Java, A Few Patterns》笔记 1.0 documentation" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="index.html">《A Little Java, A Few Patterns》笔记 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="a-little-java-a-few-patterns">
<h1><a class="toc-backref" href="#id6">《A Little Java, A Few Patterns》笔记</a><a class="headerlink" href="#a-little-java-a-few-patterns" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">tags:</th><td class="field-body">java, oop, design pattern, functional</td>
</tr>
<tr class="field-even field"><th class="field-name">category:</th><td class="field-body">java</td>
</tr>
</tbody>
</table>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#a-little-java-a-few-patterns" id="id6">《A Little Java, A Few Patterns》笔记</a><ul>
<li><a class="reference internal" href="#java" id="id7">Java小用</a></li>
<li><a class="reference internal" href="#modern-toys" id="id8">Modern Toys</a><ul>
<li><a class="reference internal" href="#seasoningd" id="id9">SeasoningD</a></li>
<li><a class="reference internal" href="#pointd" id="id10">PointD</a></li>
<li><a class="reference internal" href="#numd" id="id11">NumD</a></li>
<li><a class="reference internal" href="#layerd" id="id12">LayerD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#methods-to-our-madness" id="id13">Methods to Our Madness</a><ul>
<li><a class="reference internal" href="#id1" id="id14">PointD</a></li>
<li><a class="reference internal" href="#shishd" id="id15">ShishD</a></li>
<li><a class="reference internal" href="#kebabd" id="id16">KebabD</a></li>
<li><a class="reference internal" href="#id2" id="id17">PointD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#what-s-new" id="id18">What&#8217;s New?</a><ul>
<li><a class="reference internal" href="#pizzad" id="id19">PizzaD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#come-to-our-carousel" id="id20">Come to Our Carousel</a><ul>
<li><a class="reference internal" href="#id3" id="id21">ShishD</a></li>
<li><a class="reference internal" href="#id4" id="id22">PizzaD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objects-are-people-too" id="id23">Objects Are People, Too</a><ul>
<li><a class="reference internal" href="#pied" id="id24">PieD</a></li>
<li><a class="reference internal" href="#fishd" id="id25">FishD</a></li>
<li><a class="reference internal" href="#id5" id="id26">NumD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#boring-protocols" id="id27">Boring Protocols</a></li>
<li><a class="reference internal" href="#oh-my" id="id28">Oh My!</a></li>
<li><a class="reference internal" href="#like-father-like-son" id="id29">Like Father, Like Son</a></li>
<li><a class="reference internal" href="#be-a-good-visitor" id="id30">Be a Good Visitor</a></li>
<li><a class="reference internal" href="#the-state-of-things-to-come" id="id31">The State of Things to Come</a></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="java">
<h2><a class="toc-backref" href="#id7">Java小用</a><a class="headerlink" href="#java" title="Permalink to this headline">¶</a></h2>
<p>下面是一些有关Java体验的提示：</p>
<ol class="arabic">
<li><p class="first">在一个文件中给出类的完整层次。</p>
</li>
<li><p class="first">对于每个命名不以上标D、V、I、M结尾的类，添加 <cite>toString</cite> 方法，并遵守以下规则：</p>
<ol class="loweralpha">
<li><p class="first">如果一个类没有属性</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&quot;new &quot;</span> <span class="o">+</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;()&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">如果一个类只有一个属性，比如叫 <cite>x</cite></p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&quot;new &quot;</span> <span class="o">+</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">如果一个类有两个属性，比如叫 <cite>x</cite> 和 <cite>y</cite></p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&quot;new &quot;</span> <span class="o">+</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">在文件的底部添加如下类：</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
        <span class="n">DataType_or_Interface</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="n">______</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="o">...</span> <span class="o">...</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
</ol>
<p><cite>DataType_or_Interface y = new ______;</cite> 是用来创建你想尝试的对象。</p>
<p><cite>System.out.println( ... ... );</cite> 是用来填写你想尝试的表达式。</p>
<p>比如，你想尝试第2章定义的 <cite>ManhattanPt</cite> 的 <cite>distanceTo0</cite> 方法，你就可以添加如下代码到你文件的最后：</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
        <span class="n">PointD</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManhattanPt</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">8</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">y</span><span class="o">.</span><span class="na">distanceTo0</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>如果你想尝试多条表达式，就修改 <cite>y</cite> ，就像第10章里，</p>
<div class="highlight-python"><div class="highlight"><pre>y._ _ _ _ _ _;
y._ _ _ _ _ _;
y._ _ _ _ _ _
</pre></div>
</div>
<p>替换成</p>
<div class="highlight-python"><div class="highlight"><pre>y._ _ _ _ _ _ + &quot;\n&quot; +
y._ _ _ _ _ _ + &quot;\n&quot; +
y._ _ _ _ _ _
</pre></div>
</div>
<p>如果你想尝试第10章中定义的 <cite>PiemanM</cite> 的多个方法，那么你就将以下代码写在文件的最后面：</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
        <span class="n">PiemanI</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PiemanM</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
            <span class="n">y</span><span class="o">.</span><span class="na">addTop</span><span class="o">(</span><span class="k">new</span> <span class="n">Anchovy</span><span class="o">())</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span> <span class="o">+</span>
            <span class="n">y</span><span class="o">.</span><span class="na">addTop</span><span class="o">(</span><span class="k">new</span> <span class="n">Anchovy</span><span class="o">())</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span> <span class="o">+</span>
            <span class="n">y</span><span class="o">.</span><span class="na">substTop</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuna</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Anchovy</span><span class="o">())</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<ol class="arabic" start="4">
<li><p class="first">最后，编译文件并且执行 <cite>Main</cite> 类。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>按照上面的要求，保存的代码的文件名同时也要为 <cite>Main.java</cite> 。(因为Java会根据文件名来查找其文件内同名的类，再执行该类的main方法)</p>
<p>然后使用 <cite>javac Main.java</cite> 来进行编译生成 <cite>Main.class</cite> 中间码文件。</p>
<p>最后， <cite>java Main</cite> 来执行程序。</p>
<p class="last">建议大家上网搜索一下 <cite>Java helloworld</cite> 看一下相关教程就可以了。暂时不用深入学习 <cite>Java</cite> 。</p>
</div>
</li>
</ol>
</div>
<div class="section" id="modern-toys">
<h2><a class="toc-backref" href="#id8">Modern Toys</a><a class="headerlink" href="#modern-toys" title="Permalink to this headline">¶</a></h2>
<p>这一章节，作者通过一系列的对话，让读者了解到Java中基本类型（只介绍了int, boolean类型），然后引申到如何使用Java自定义类型。</p>
<p>类型是什么？</p>
<div class="highlight-python"><div class="highlight"><pre>A type is a name for a collection of values
</pre></div>
</div>
<div class="section" id="seasoningd">
<h3><a class="toc-backref" href="#id9">SeasoningD</a><a class="headerlink" href="#seasoningd" title="Permalink to this headline">¶</a></h3>
<p>自定义 <cite>SeasoningD</cite> 类型，以其它的四个子类型。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SeasoningD</span><span class="o">{}</span> <span class="c1">//调味品</span>

<span class="kd">class</span> <span class="nc">Salt</span> <span class="kd">extends</span> <span class="n">SeasoningD</span><span class="o">{}</span> <span class="c1">//盐</span>

<span class="kd">class</span> <span class="nc">Pepper</span> <span class="kd">extends</span> <span class="n">SeasoningD</span><span class="o">{}</span> <span class="c1">//胡椒粉</span>

<span class="kd">class</span> <span class="nc">Thyme</span> <span class="kd">extends</span> <span class="n">SeasoningD</span><span class="o">{}</span> <span class="c1">//百里香</span>

<span class="kd">class</span> <span class="nc">Sage</span> <span class="kd">extends</span> <span class="n">SeasoningD</span><span class="o">{}</span> <span class="c1">//鼠尾草</span>
</pre></div>
</div>
<p>虽然四个子类型没有定义 <cite>构造函数</cite> ，但是Java会自动添加一个默认的构造函数。</p>
</div>
<div class="section" id="pointd">
<h3><a class="toc-backref" href="#id10">PointD</a><a class="headerlink" href="#pointd" title="Permalink to this headline">¶</a></h3>
<p>再自定义个 <cite>PointD</cite> 类型，和它的两个子类型。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PointD</span><span class="o">{}</span> <span class="c1">//坐标</span>

<span class="kd">class</span> <span class="nc">CartesianPt</span> <span class="kd">extends</span> <span class="n">PointD</span><span class="o">{</span> <span class="c1">//笛卡尔坐标</span>
    <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
    <span class="n">CartesianPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_x</span><span class="o">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ManhattanPt</span> <span class="kd">extends</span> <span class="n">PointD</span><span class="o">{</span> <span class="c1">//曼哈顿坐标</span>
    <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
    <span class="n">ManhattanPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_x</span><span class="o">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>PointD的两个子类型就手动添加了构造函数，因为它们需要有额外的属性传入构造函数。</p>
<p>当使用 <cite>new</cite> 关键字时， Java会通过调用类的构造函数来生成其对应的实例。</p>
<p>对抽象类直接使用 <cite>new</cite> 关键字是不行的，因为抽象类是一个未完全定义的类，无法实例化。</p>
</div>
<div class="section" id="numd">
<h3><a class="toc-backref" href="#id11">NumD</a><a class="headerlink" href="#numd" title="Permalink to this headline">¶</a></h3>
<p>再定义个 <cite>NumD</cite> 类型，和它的两个子类型。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">NumD</span><span class="o">{}</span>

<span class="kd">class</span> <span class="nc">Zero</span> <span class="kd">extends</span> <span class="n">NumD</span><span class="o">{}</span>

<span class="kd">class</span> <span class="nc">OneMoreThan</span> <span class="kd">extends</span> <span class="n">NumD</span><span class="o">{</span>
    <span class="n">NumD</span> <span class="n">predecessor</span><span class="o">;</span>
    <span class="n">OneMoreThan</span><span class="o">(</span><span class="n">NumD</span> <span class="n">_d</span><span class="o">){</span>
        <span class="n">predecessor</span> <span class="o">=</span> <span class="n">_d</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>使用这两个子类型，就可以表示一个整数系统。</p>
<ol class="arabic simple">
<li><cite>Zero</cite> 表示 <cite>0</cite></li>
<li><cite>new OneMoreThan(new Zero())</cite> 表示 <cite>1</cite></li>
<li><cite>new OneMoreThan(new OneMoreThan(new Zero()))</cite> 表示 <cite>2</cite></li>
<li>... ...</li>
</ol>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">上面的概念其实就是 <a class="reference external" href="http://en.wikipedia.org/wiki/Church_encoding">Church encoding</a></p>
</div>
<p><cite>abstract</cite> 、 <cite>class</cite> 、 <cite>extends</cite> 各代表什么？</p>
<div class="highlight-python"><div class="highlight"><pre>`abstract` 定义类型

`class` 定义子类型

`extends` 将以上两者联系起来
</pre></div>
</div>
<p><strong>第一条建议</strong></p>
<blockquote>
<div><p>When specifying a collection of data,</p>
<p>use <em>abstract</em> classes for datatypes and</p>
<p><em>extended</em> classes for variants.</p>
</div></blockquote>
</div>
<div class="section" id="layerd">
<h3><a class="toc-backref" href="#id12">LayerD</a><a class="headerlink" href="#layerd" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">LayerD</span><span class="o">{}</span>

<span class="kd">class</span> <span class="nc">Base</span> <span class="kd">extends</span> <span class="n">LayerD</span><span class="o">{</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">Base</span><span class="o">(</span><span class="n">Object</span> <span class="n">_o</span><span class="o">){</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Slice</span> <span class="kd">extends</span> <span class="n">LayerD</span><span class="o">{</span>
    <span class="n">LayerD</span> <span class="n">l</span><span class="o">;</span>
    <span class="n">Slice</span><span class="o">(</span><span class="n">LayerD</span> <span class="n">_l</span><span class="o">){</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">_l</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>书中通过一系列对话和示例来揭示自定义类型与Java提供的基本类型的不同之处，给读者一个基本印象：基本类型不能直接作用于自定义类型，而是将之先转换为类似自定义类型的形式，然后才能使用。</p>
<p>接下来的章节会其进行进一步的揭示。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Java不能说是完全的面向对象。为了性能考虑，Java的基本类型并非对象。</p>
<p>如果需要将之转换为对象，需要使用Java提供的包装类才行。</p>
<p class="last">如果想深入了解：请Google <cite>Java 基本类型 引用类型</cite></p>
</div>
</div>
</div>
<div class="section" id="methods-to-our-madness">
<h2><a class="toc-backref" href="#id13">Methods to Our Madness</a><a class="headerlink" href="#methods-to-our-madness" title="Permalink to this headline">¶</a></h2>
<p>上一章讲解了如何在Java中的定义类型。</p>
<p>这一章主要讲如何向这些类型添加方法。</p>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id14">PointD</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PointD</span><span class="o">{</span>
    <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">CartesianPt</span> <span class="kd">extends</span> <span class="n">PointD</span><span class="o">{</span> <span class="c1">//笛卡尔坐标</span>
    <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
    <span class="n">CartesianPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_x</span><span class="o">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ManhattanPt</span> <span class="kd">extends</span> <span class="n">PointD</span><span class="o">{</span> <span class="c1">//曼哈顿坐标</span>
    <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
    <span class="n">ManhattanPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_x</span><span class="o">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>当子类型（具体类）从类型（抽象类）继承时，需要同时实现抽象类中的抽象方法。</p>
</div>
<div class="section" id="shishd">
<h3><a class="toc-backref" href="#id15">ShishD</a><a class="headerlink" href="#shishd" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// 书上的例子中各个类一层层的套在一起，可以理解成一个烤串</span>
<span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ShishD</span> <span class="o">{</span> <span class="c1">//羊肉串</span>
    <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">onlyOnions</span><span class="o">();</span> <span class="c1">//烤串上是不是只有洋葱</span>
    <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">isVegetarian</span><span class="o">();</span> <span class="c1">//烤串上是不是全是蔬菜</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Skewer</span> <span class="kd">extends</span> <span class="n">ShishD</span> <span class="o">{</span> <span class="c1">//串，烤肉叉子</span>
    <span class="kt">boolean</span> <span class="nf">onlyOnions</span><span class="o">(){</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="nf">isVegetarian</span><span class="o">(){</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Onion</span> <span class="kd">extends</span> <span class="n">ShishD</span> <span class="o">{</span> <span class="c1">//洋葱</span>
    <span class="n">ShishD</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">Onion</span><span class="o">(</span><span class="n">ShishD</span> <span class="n">_s</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_s</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="nf">onlyOnions</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">onlyOnions</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="nf">isVegetarian</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">isVegetarian</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Lamb</span> <span class="kd">extends</span> <span class="n">ShishD</span> <span class="o">{</span> <span class="c1">//羔羊肉</span>
    <span class="n">ShishD</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">Lamb</span><span class="o">(</span><span class="n">ShishD</span> <span class="n">_s</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_s</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="nf">onlyOnions</span><span class="o">(){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="nf">isVegetarian</span><span class="o">(){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Tomato</span> <span class="kd">extends</span> <span class="n">ShishD</span> <span class="o">{</span> <span class="c1">//西红柿</span>
    <span class="n">ShishD</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">Tomato</span><span class="o">(</span><span class="n">ShishD</span> <span class="n">_s</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_s</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="nf">onlyOnions</span><span class="o">(){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="nf">isVegetarian</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">isVegetarian</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><strong>第二条建议</strong></p>
<blockquote>
<div><p>When writing a function over a datatype,</p>
<p>place a method in each of the variants that make up the datatype.</p>
<p>If a field of a variant belongs to the same datatype,</p>
<p>the method may call the corresponding method of the field in</p>
<p>computing the function.</p>
</div></blockquote>
</div>
<div class="section" id="kebabd">
<h3><a class="toc-backref" href="#id16">KebabD</a><a class="headerlink" href="#kebabd" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">KebabD</span> <span class="o">{</span> <span class="c1">//烤肉</span>
    <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">isVeggie</span><span class="o">();</span> <span class="c1">//是否以纯蔬菜为辅料的烤肉</span>
    <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">whatHolder</span><span class="o">();</span> <span class="c1">//烤肉的摆放工具是什么</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Holder</span> <span class="kd">extends</span> <span class="n">KebabD</span> <span class="o">{</span> <span class="c1">//烤肉摆放工具（意译）</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">Holder</span> <span class="o">(</span><span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">isVeggie</span><span class="o">(){</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">whatHolder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Shallot</span> <span class="kd">extends</span> <span class="n">KebabD</span> <span class="o">{</span> <span class="c1">//葱</span>
    <span class="n">KebabD</span> <span class="n">k</span><span class="o">;</span>
    <span class="n">Shallot</span><span class="o">(</span><span class="n">KebabD</span> <span class="n">_k</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">_k</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">isVeggie</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="na">isVeggie</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">whatHolder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="na">whatHolder</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Shrimp</span> <span class="kd">extends</span> <span class="n">KebabD</span> <span class="o">{</span> <span class="c1">//小虾</span>
    <span class="n">KebabD</span> <span class="n">k</span><span class="o">;</span>
    <span class="n">Shrimp</span><span class="o">(</span><span class="n">KebabD</span> <span class="n">_k</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">_k</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">isVeggie</span><span class="o">(){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">whatHolder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="na">whatHolder</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Radish</span> <span class="kd">extends</span> <span class="n">KebabD</span> <span class="o">{</span> <span class="c1">//萝卜</span>
    <span class="n">KebabD</span> <span class="n">k</span><span class="o">;</span>
    <span class="n">Radish</span><span class="o">(</span><span class="n">KebabD</span> <span class="n">_k</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">_k</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">isVeggie</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="na">isVeggie</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">whatHolder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="na">whatHolder</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Pepper</span> <span class="kd">extends</span> <span class="n">KebabD</span> <span class="o">{</span> <span class="c1">//胡椒粉</span>
    <span class="n">KebabD</span> <span class="n">k</span><span class="o">;</span>
    <span class="n">Pepper</span><span class="o">(</span><span class="n">KebabD</span> <span class="n">_k</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">_k</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">isVeggie</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="na">isVeggie</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">whatHolder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="na">whatHolder</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Zucchini</span> <span class="kd">extends</span> <span class="n">KebabD</span> <span class="o">{</span> <span class="c1">//西葫芦</span>
    <span class="n">KebabD</span> <span class="n">k</span><span class="o">;</span>
    <span class="n">Zucchini</span><span class="o">(</span><span class="n">KebabD</span> <span class="n">_k</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">_k</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">isVeggie</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="na">isVeggie</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">whatHolder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="na">whatHolder</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>定义一下烤肉摆放的工具。</p>
<p>大致分成两种:</p>
<ul>
<li><p class="first">一种是将烤肉串起来的工具</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">RodD</span><span class="o">{}</span> <span class="c1">//杆，用于将烤肉串起来</span>

<span class="kd">class</span> <span class="nc">Dagger</span> <span class="kd">extends</span> <span class="n">RodD</span><span class="o">{}</span> <span class="c1">//匕首</span>

<span class="kd">class</span> <span class="nc">Sabre</span> <span class="kd">extends</span> <span class="n">RodD</span><span class="o">{}</span> <span class="c1">//军刀</span>

<span class="kd">class</span> <span class="nc">Sword</span> <span class="kd">extends</span> <span class="n">RodD</span><span class="o">{}</span> <span class="c1">//剑</span>
</pre></div>
</div>
</li>
<li><p class="first">一种将烤肉平铺的工具。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PlateD</span><span class="o">{}</span> <span class="c1">//盘子</span>

<span class="kd">class</span> <span class="nc">Gold</span> <span class="kd">extends</span> <span class="n">PlateD</span><span class="o">{}</span> <span class="c1">//金盘子</span>

<span class="kd">class</span> <span class="nc">Silver</span> <span class="kd">extends</span> <span class="n">PlateD</span><span class="o">{}</span> <span class="c1">//银盘子</span>

<span class="kd">class</span> <span class="nc">Brass</span> <span class="kd">extends</span> <span class="n">PlateD</span><span class="o">{}</span> <span class="c1">//黄铜盘子</span>

<span class="kd">class</span> <span class="nc">Copper</span> <span class="kd">extends</span> <span class="n">PlateD</span><span class="o">{}</span> <span class="c1">//镀铜盘子</span>

<span class="kd">class</span> <span class="nc">Wood</span> <span class="kd">extends</span> <span class="n">PlateD</span><span class="o">{}</span> <span class="c1">//木盘子</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id17">PointD</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PointD</span><span class="o">{</span>
    <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">CartesianPt</span> <span class="kd">extends</span> <span class="n">PointD</span><span class="o">{</span> <span class="c1">//笛卡尔坐标</span>
    <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
    <span class="n">CartesianPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_x</span><span class="o">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">closerTo0</span><span class="o">(</span><span class="n">CartesianPt</span> <span class="n">p</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">distanceTo0</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="na">distanceTo0</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ManhattanPt</span> <span class="kd">extends</span> <span class="n">PointD</span><span class="o">{</span> <span class="c1">//曼哈顿坐标</span>
    <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
    <span class="n">ManhattanPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_x</span><span class="o">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">closerTo0</span><span class="o">(</span><span class="n">ManhattanPt</span> <span class="n">p</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">distanceTo0</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="na">distanceTo0</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>抽取变体类型中公共的部分到抽象类型中。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PointD</span><span class="o">{</span>
    <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
    <span class="n">PointD</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_x</span><span class="o">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="nf">closerTo0</span><span class="o">(</span><span class="n">PointD</span> <span class="n">p</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">distanceTo0</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="na">distanceTo0</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">CartesianPt</span> <span class="kd">extends</span> <span class="n">PointD</span><span class="o">{</span> <span class="c1">//笛卡尔坐标</span>
    <span class="n">CartesianPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ManhattanPt</span> <span class="kd">extends</span> <span class="n">PointD</span><span class="o">{</span> <span class="c1">//曼哈顿坐标</span>
    <span class="n">ManhattanPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="what-s-new">
<h2><a class="toc-backref" href="#id18">What&#8217;s New?</a><a class="headerlink" href="#what-s-new" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pizzad">
<h3><a class="toc-backref" href="#id19">PizzaD</a><a class="headerlink" href="#pizzad" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PizzaD</span> <span class="o">{</span> <span class="c1">//比萨饼</span>
    <span class="kd">abstract</span> <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">();</span> <span class="c1">//去除比萨饼中的凤尾鱼顶料(因为太咸了)</span>
    <span class="kd">abstract</span> <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">();</span> <span class="c1">//在凤尾鱼顶料上加上奶酪顶料(这样会盖住凤尾鱼的咸味)</span>
    <span class="kd">abstract</span> <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">();</span> <span class="c1">//将所有的凤尾鱼顶料换成奶酪顶料</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Crust</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//面包皮</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Crust</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Crust</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Crust</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 下面是各种顶料</span>
<span class="kd">class</span> <span class="nc">Cheese</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//奶酪</span>
    <span class="n">PizzaD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">Cheese</span> <span class="o">(</span><span class="n">PizzaD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Cheese</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">remA</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Cheese</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">topAwC</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Cheese</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">subAbC</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Olive</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//橄榄</span>
    <span class="n">PizzaD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">Olive</span> <span class="o">(</span><span class="n">PizzaD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Olive</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">remA</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Olive</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">topAwC</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Olive</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">subAbC</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Anchovy</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//凤尾鱼</span>
    <span class="n">PizzaD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">Anchovy</span> <span class="o">(</span><span class="n">PizzaD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">remA</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Cheese</span><span class="o">(</span><span class="k">new</span> <span class="n">Anchovy</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">topAwC</span><span class="o">()));</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Cheese</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">subAbC</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Sausage</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//香肠</span>
    <span class="n">PizzaD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">Sausage</span> <span class="o">(</span><span class="n">PizzaD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Sausage</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">remA</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Sausage</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">topAwC</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Sausage</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">subAbC</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>如果想要在比萨饼上面添加额外的顶料怎么办？</p>
<p>很简单，再从 <cite>PizzaD</cite> 扩展出一个新的子类型就可以了。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">Spinach</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//菠菜</span>
    <span class="n">PizzaD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">Spinach</span> <span class="o">(</span><span class="n">PizzaD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Spinach</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">remA</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Spinach</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">topAwC</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Spinach</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">subAbC</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>但是每添加一个新的变体类型都要加上三个方法，好累的说。</p>
<p>有什么比较好的办法解决这个问题呢？</p>
<blockquote>
<div>下一章节给你答案。</div></blockquote>
<p><strong>第三条建议</strong></p>
<blockquote>
<div><p>When writing a function that returns values of a datatype,</p>
<p>use <em>new</em> to create these values.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="come-to-our-carousel">
<h2><a class="toc-backref" href="#id20">Come to Our Carousel</a><a class="headerlink" href="#come-to-our-carousel" title="Permalink to this headline">¶</a></h2>
<p>这一章节就针对上一章节暴露的问题，提出解决方法：</p>
<blockquote>
<div><strong>访问者模式</strong></div></blockquote>
<p>不过作者没有一上来就给出完美的实现，它是通过一步步来引导的。</p>
<p>下面的两个例子只是第一步：</p>
<div class="highlight-python"><div class="highlight"><pre>先将类似的方法聚合到访问者类中
</pre></div>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id21">ShishD</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// 访问者</span>
<span class="kd">class</span> <span class="nc">OnlyOnionsV</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">forSkewer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">forOnion</span><span class="o">(</span><span class="n">ShishD</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">onlyOnions</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">forLamb</span><span class="o">(</span><span class="n">ShishD</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">forTomato</span><span class="o">(</span><span class="n">ShishD</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">IsVegetarianV</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">forSkewer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ture</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">forOnion</span><span class="o">(</span><span class="n">ShishD</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">IsVegetarian</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">forLamb</span><span class="o">(</span><span class="n">ShishD</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">forTomato</span><span class="o">(</span><span class="n">ShishD</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">IsVegetarian</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// 使用访问者模式的ShishD</span>
<span class="c1">// 这里可以对比一下第二章节的ShishD代码</span>
<span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ShishD</span> <span class="o">{</span> <span class="c1">//羊肉</span>
    <span class="n">OnlyOnionsV</span> <span class="n">ooFn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnlyOnionsV</span><span class="o">();</span>
    <span class="n">IsVegetarianV</span> <span class="n">ivFn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IsVegetarianV</span><span class="o">();</span>
    <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">onlyOnions</span><span class="o">();</span>
    <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">IsVegetarian</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Skewer</span> <span class="kd">extends</span> <span class="n">ShishD</span> <span class="o">{</span> <span class="c1">//串</span>
    <span class="kt">boolean</span> <span class="nf">onlyOnions</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ooFn</span><span class="o">.</span><span class="na">forSkewer</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">IsVegetarian</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ivFn</span><span class="o">.</span><span class="na">forSkewer</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Onion</span> <span class="kd">extends</span> <span class="n">ShishD</span> <span class="o">{</span> <span class="c1">//洋葱</span>
    <span class="n">ShishD</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">Onion</span> <span class="o">(</span><span class="n">ShishD</span> <span class="n">_s</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_s</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">onlyOnions</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ooFn</span><span class="o">.</span><span class="na">forOnion</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">IsVegetarian</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ivFn</span><span class="o">.</span><span class="na">forOnion</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Lamb</span> <span class="kd">extends</span> <span class="n">ShishD</span> <span class="o">{</span> <span class="c1">//羔羊肉</span>
    <span class="n">ShishD</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">Lamb</span> <span class="o">(</span><span class="n">ShishD</span> <span class="n">_s</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_s</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">onlyLambs</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ooFn</span><span class="o">.</span><span class="na">forLamb</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">IsVegetarian</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ivFn</span><span class="o">.</span><span class="na">forLamb</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Tomato</span> <span class="kd">extends</span> <span class="n">ShishD</span> <span class="o">{</span> <span class="c1">//西红柿</span>
    <span class="n">ShishD</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">Tomato</span> <span class="o">(</span><span class="n">ShishD</span> <span class="n">_s</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_s</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">onlyTomatos</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ooFn</span><span class="o">.</span><span class="na">forTomato</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">IsVegetarian</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ivFn</span><span class="o">.</span><span class="na">forTomato</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><strong>第四条建议</strong></p>
<blockquote>
<div><p>When writing several functions for the</p>
<p>same self-referential datatype, use</p>
<p>visitor protocols so that all methods for</p>
<p>a function can be found in a single class.</p>
</div></blockquote>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id22">PizzaD</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PizzaD</span> <span class="o">{</span> <span class="c1">//披萨饼</span>
    <span class="n">RemAV</span> <span class="n">remFn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RemAV</span><span class="o">();</span>
    <span class="n">TopAwCV</span> <span class="n">topFn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopAwCV</span><span class="o">();</span>
    <span class="n">SubAbCV</span> <span class="n">subFn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubAbCV</span><span class="o">();</span>
    <span class="kd">abstract</span> <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">();</span>
    <span class="kd">abstract</span> <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">();</span>
    <span class="kd">abstract</span> <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Crust</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//面包皮</span>
    <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forCrust</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">topFn</span><span class="o">.</span><span class="na">forCrust</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">subFn</span><span class="o">.</span><span class="na">forCrust</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Cheese</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//奶酪</span>
    <span class="n">PizzaD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">Cheese</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forCheese</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">topFn</span><span class="o">.</span><span class="na">forCheese</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">subFn</span><span class="o">.</span><span class="na">forCheese</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="n">Classr</span> <span class="n">Olive</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//橄榄</span>
    <span class="n">PizzaD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">Olive</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forOlive</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">topFn</span><span class="o">.</span><span class="na">forOlive</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">subFn</span><span class="o">.</span><span class="na">forOlive</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Anchovy</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//凤尾鱼</span>
    <span class="n">PizzaD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">Anchovy</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forAnchovy</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">topFn</span><span class="o">.</span><span class="na">forAnchovy</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">subFn</span><span class="o">.</span><span class="na">forAnchovy</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Sausage</span> <span class="kd">extends</span> <span class="n">PizzaD</span> <span class="o">{</span> <span class="c1">//香肠</span>
    <span class="n">PizzaD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">Sausage</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">remA</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forSausage</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">topAwC</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">topFn</span><span class="o">.</span><span class="na">forSausage</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">subAbC</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">subFn</span><span class="o">.</span><span class="na">forSausage</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">RemAV</span> <span class="o">{</span>
    <span class="n">PizzaD</span> <span class="nf">forCrust</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Crust</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forCheese</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Cheese</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">remA</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forOlive</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Olive</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">remA</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forAnchovy</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">remA</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forSausage</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Sausage</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">remA</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">TopAwCV</span> <span class="o">{</span>
    <span class="n">PizzaD</span> <span class="nf">forCrust</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Crust</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forCheese</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Cheese</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">topAwC</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forOlive</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Olive</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">topAwC</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forAnchovy</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Cheese</span><span class="o">(</span><span class="k">new</span> <span class="n">Anchovy</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">topAwC</span><span class="o">()));</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forSausage</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Sausage</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">topAwC</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SubAbCV</span> <span class="o">{</span>
    <span class="n">PizzaD</span> <span class="nf">forCrust</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Crust</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forCheese</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Cheese</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">subAbC</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forOlive</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Olive</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">subAbC</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forAnchovy</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Cheese</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">subAbC</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">PizzaD</span> <span class="nf">forSausage</span><span class="o">(</span><span class="n">PizzaD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Sausage</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">subAbC</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="objects-are-people-too">
<h2><a class="toc-backref" href="#id23">Objects Are People, Too</a><a class="headerlink" href="#objects-are-people-too" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pied">
<h3><a class="toc-backref" href="#id24">PieD</a><a class="headerlink" href="#pied" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PieD</span> <span class="o">{</span> <span class="c1">//馅饼，派</span>
    <span class="n">RemAV</span> <span class="n">raFn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RemAV</span><span class="o">();</span>
    <span class="n">RemFishV</span> <span class="n">rfFn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RemFishV</span><span class="o">();</span>
    <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">remA</span><span class="o">();</span>
    <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">remFish</span><span class="o">(</span><span class="n">FishD</span> <span class="n">f</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bot</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span> <span class="c1">//底料</span>
    <span class="n">PieD</span> <span class="nf">remA</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">raFn</span><span class="o">.</span><span class="na">forBot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">Pied</span> <span class="nf">remFish</span><span class="o">(</span><span class="n">FishD</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">rfFn</span><span class="o">.</span><span class="na">forBot</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Top</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span> <span class="c1">//顶料</span>
    <span class="n">Object</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">PieD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Top</span><span class="o">(</span><span class="n">Object</span> <span class="n">_t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">,</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">,</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">remA</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">raFn</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">remFish</span><span class="o">(</span><span class="n">FishD</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">rfFn</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="fishd">
<h3><a class="toc-backref" href="#id25">FishD</a><a class="headerlink" href="#fishd" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">FishD</span> <span class="o">{}</span>

<span class="kd">class</span> <span class="nc">Anchovy</span> <span class="kd">extends</span> <span class="n">FishD</span> <span class="o">{</span> <span class="c1">//凤尾鱼</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Anchovy</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Salmon</span> <span class="kd">extends</span> <span class="n">FishD</span> <span class="o">{</span> <span class="c1">//鲑鱼</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Salmon</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Tuna</span> <span class="kd">extends</span> <span class="n">FishD</span> <span class="o">{</span> <span class="c1">//金枪鱼</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Tuna</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// 删除凤尾鱼的方法</span>
<span class="kd">class</span> <span class="nc">RemAV</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="n">Anchovy</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">remA</span><span class="o">();</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">remA</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 删除指定鱼的方法，相当在 `RemAV` 的概念上再抽象一层</span>
<span class="kd">class</span> <span class="nc">RemFishV</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">FishD</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">,</span> <span class="n">FishD</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">remFish</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">remFish</span><span class="o">(</span><span class="n">f</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 删除指定整数的方法</span>
<span class="kd">class</span> <span class="nc">RemIntV</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Integer</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">remInt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">remInt</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><cite>RemFishV</cite> 和  <cite>RemIntV</cite> 的整个逻辑很类似么，那么将它们重新抽象一下？</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">RemV</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">rem</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">rem</span><span class="o">(</span><span class="n">o</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><cite>PieD</cite> 及它的变种类型 <cite>Bot</cite>  <cite>Top</cite> 也要简单变化一下。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PieD</span> <span class="o">{</span>
    <span class="n">RemV</span> <span class="n">remFn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RemV</span><span class="o">();</span>
    <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bot</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forBot</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Top</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">PieD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Top</span><span class="o">(</span><span class="n">Object</span> <span class="n">_t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">_r</span><span class="o">){</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</div>
<p>现在的 <cite>Bot</cite>  <cite>Top</cite> 在调用rem时，即可以传入 <cite>FishD</cite> 也可以传入 <cite>Integer</cite> 了。</p>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id26">NumD</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">NumD</span> <span class="o">{}</span>

<span class="kd">class</span> <span class="nc">OneMoreThan</span> <span class="kd">extends</span> <span class="n">NumD</span> <span class="o">{</span>
    <span class="n">NumD</span> <span class="n">predecessor</span><span class="o">;</span>
    <span class="n">OneMoreThan</span><span class="o">(</span><span class="n">NumD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">predecessor</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">OneMoreThan</span><span class="o">)</span>
            <span class="k">return</span> <span class="n">predecessor</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span>
                <span class="o">((</span><span class="n">OneMoreThan</span><span class="o">)</span><span class="n">o</span><span class="o">).</span><span class="na">predecessor</span>
            <span class="o">),</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Zero</span> <span class="kd">extends</span> <span class="n">NumD</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Zero</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">SubstFishV</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">FishD</span> <span class="n">n</span><span class="o">,</span> <span class="n">FishD</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span> <span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">,</span> <span class="n">FishD</span> <span class="n">n</span><span class="o">,</span> <span class="n">FishD</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">substFish</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">substFish</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SubstIntV</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Integer</span> <span class="n">n</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span> <span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">n</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">substInt</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">substInt</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SubstV</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span> <span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">,</span> <span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">subst</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">subst</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><cite>SubstV</cite> 和  <cite>RemV</cite> 的做法是一样。</p>
<p>再整理一下 <cite>PieD</cite></p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PieD</span> <span class="o">{</span>
    <span class="n">RemV</span> <span class="n">remFn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RemV</span><span class="o">();</span>
    <span class="n">SubsbV</span> <span class="n">substFn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubstV</span><span class="o">();</span>
    <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">);</span>
    <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">subst</span><span class="o">(</span><span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bot</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forBot</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">subst</span><span class="o">(</span><span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">substFn</span><span class="o">.</span><span class="na">forBot</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Top</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">PieD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Top</span><span class="o">(</span><span class="n">Object</span> <span class="n">_t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">_r</span><span class="o">){</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">subst</span><span class="o">(</span><span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">substFn</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="boring-protocols">
<h2><a class="toc-backref" href="#id27">Boring Protocols</a><a class="headerlink" href="#boring-protocols" title="Permalink to this headline">¶</a></h2>
<p>之前5章看起来还真是 <cite>Boring</cite> 。</p>
<p>这一章的名称中虽然有 <cite>Boring</cite> ，但是内容却是很有趣的。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">这里的 <cite>Protocols</cite> 我觉得应该指的是 <cite>Interface</cite> 的意思。</p>
</div>
<hr class="docutils" />
<p>本章接着上一章节的最后代码继续讲解。</p>
<p>这次将 <cite>remFn</cite>  <cite>substFn</cite> 放入到参数的位置。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PieD</span> <span class="o">{</span>
    <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">RemV</span> <span class="n">remFn</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">);</span>
    <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">subst</span><span class="o">(</span><span class="n">SubstV</span> <span class="n">substFn</span><span class="o">,</span> <span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Top</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">PieD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Top</span><span class="o">(</span><span class="n">Object</span> <span class="n">_t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">RemV</span> <span class="n">remFn</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">subst</span><span class="o">(</span><span class="n">SubstV</span> <span class="n">substFn</span><span class="o">,</span> <span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sbustFn</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bot</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">PieD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Bot</span><span class="o">(</span><span class="n">Object</span> <span class="n">_t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">RemV</span> <span class="n">remFn</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forBot</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">subst</span><span class="o">(</span><span class="n">SubstV</span> <span class="n">substFn</span><span class="o">,</span> <span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sbustFn</span><span class="o">.</span><span class="na">forBot</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>同步修改对应的访问者类。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">RemV</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">rem</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">rem</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">o</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SubstV</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">,</span> <span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">subst</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">subst</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>再修改访问者类，将更多的参数传入到访问者类中。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">RemV</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">RemV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">rem</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">rem</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SubstV</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">n</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">SubstV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">){</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_n</span><span class="o">;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">subst</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">subst</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>上面的形式就有点函数式编程里面的 <strong>闭包</strong> 的意味了。</p>
<p>好了，根据上面修改后的 <cite>SubstV</cite> ，重新修改一下 <cite>PieD</cite> 及其 <cite>Bot</cite> 和 <cite>Top</cite></p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PieD</span> <span class="o">{</span>
    <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">RemV</span> <span class="n">remFn</span><span class="o">);</span>
    <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">subst</span><span class="o">(</span><span class="n">SubstV</span> <span class="n">substFn</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Top</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">PieD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Top</span><span class="o">(</span><span class="n">Object</span> <span class="n">_t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">RemV</span> <span class="n">remFn</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">subst</span><span class="o">(</span><span class="n">SubstV</span> <span class="n">substFn</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sbustFn</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bot</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">PieD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Bot</span><span class="o">(</span><span class="n">Object</span> <span class="n">_t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">rem</span><span class="o">(</span><span class="n">RemV</span> <span class="n">remFn</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">remFn</span><span class="o">.</span><span class="na">forBot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">subst</span><span class="o">(</span><span class="n">SubstV</span> <span class="n">substFn</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sbustFn</span><span class="o">.</span><span class="na">forBot</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>在 <cite>Top</cite> 和 <cite>Bot</cite> 类中， <cite>rem</cite> 和 <cite>subst</cite> 的代码都很类似，</p>
<p>所以我们可以进一步抽象。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">前方高能预警，高潮就要到来了。</p>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// abstract class PieVisitorD {</span>
<span class="c1">//     abstract PieD forBot();</span>
<span class="c1">//     abstract PieD forTop(Object t, PieD r);</span>
<span class="c1">// }</span>

<span class="kd">interface</span> <span class="nc">PieVisitorI</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">();</span>
    <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">RemV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">RemV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SbustV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">n</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">SubstV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_n</span><span class="o">;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">fotTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>同步修改 <cite>PieD</cite></p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PieD</span> <span class="o">{</span>
    <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">accept</span><span class="o">(</span><span class="n">PieVisitorI</span> <span class="n">ask</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bot</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="nf">accept</span><span class="o">(</span><span class="n">PieVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forBot</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Top</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">PieD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Top</span><span class="o">(</span><span class="n">Object</span> <span class="n">_t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">PieD</span> <span class="nf">accept</span><span class="o">(</span><span class="n">PieVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// 有限制次数的替换</span>
<span class="kd">class</span> <span class="nc">LtdSubstV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">c</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">n</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">LtdSubstV</span><span class="o">(</span><span class="kt">int</span> <span class="n">_c</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_c</span><span class="o">;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_n</span><span class="o">;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">LtdSubstV</span><span class="o">(</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">)));</span>
            <span class="k">else</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>第六条建议</strong></p>
<p>When the additional consumed values</p>
<p>change for a self-referenced use of a</p>
<p class="last">visitor, don&#8217;t forget to create a new visitor.</p>
</div>
</div>
<div class="section" id="oh-my">
<h2><a class="toc-backref" href="#id28">Oh My!</a><a class="headerlink" href="#oh-my" title="Permalink to this headline">¶</a></h2>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">FruitD</span> <span class="o">{}</span> <span class="c1">// 水果</span>

<span class="kd">class</span> <span class="nc">Peach</span> <span class="kd">extends</span> <span class="n">FruitD</span> <span class="o">{</span>  <span class="c1">//桃</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Peach</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Apple</span> <span class="kd">extends</span> <span class="n">FruitD</span> <span class="o">{</span> <span class="c1">//苹果</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Apple</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Pear</span> <span class="kd">extends</span> <span class="n">FruitD</span> <span class="o">{</span> <span class="c1">//梨</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Pear</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Lemon</span> <span class="kd">extends</span> <span class="n">FruitD</span> <span class="o">{</span> <span class="c1">//柠檬</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Lemon</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Fig</span> <span class="kd">extends</span> <span class="n">FruitD</span> <span class="o">{</span> <span class="c1">//无花果</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Fig</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TreeD</span> <span class="o">{</span> <span class="c1">//树</span>
    <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">bTreeVisitorI</span> <span class="n">ask</span><span class="o">);</span>
    <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">accept</span><span class="o">(</span><span class="n">iTreeVisitorI</span> <span class="n">ask</span><span class="o">);</span>
    <span class="kd">abstract</span> <span class="n">TreeD</span> <span class="nf">accept</span><span class="o">(</span><span class="n">tTreeVisitorI</span> <span class="n">ask</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bud</span> <span class="kd">extends</span> <span class="n">TreeD</span> <span class="o">{</span> <span class="c1">//芽</span>
    <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">bTreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forBud</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">accept</span><span class="o">(</span><span class="n">iTreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forBud</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">TreeD</span> <span class="nf">accept</span><span class="o">(</span><span class="n">tTreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forBud</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Flat</span> <span class="kd">extends</span> <span class="n">TreeD</span> <span class="o">{</span> <span class="c1">//平顶</span>
    <span class="n">FruitD</span> <span class="n">f</span><span class="o">;</span>
    <span class="n">TreeD</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">Flat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">_f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">_t</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">_f</span><span class="o">;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">bTreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forFlat</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">accept</span><span class="o">(</span><span class="n">iTreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forFlat</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">TreeD</span> <span class="nf">accept</span><span class="o">(</span><span class="n">tTreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forFlat</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Split</span> <span class="kd">extends</span> <span class="n">TreeD</span> <span class="o">{</span> <span class="c1">//分枝</span>
    <span class="n">TreeD</span> <span class="n">l</span><span class="o">;</span>
    <span class="n">TreeD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Split</span><span class="o">(</span><span class="n">Treed</span> <span class="n">_l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">_l</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">bTreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forSplit</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">accept</span><span class="o">(</span><span class="n">iTreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forSplit</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">TreeD</span> <span class="nf">accept</span><span class="o">(</span><span class="n">tTreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forFlat</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">interface</span> <span class="nc">bTreeVisitorI</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">forBud</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">bIsFlatV</span> <span class="kd">implements</span> <span class="n">bTreeVisitorI</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forBud</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">bIsSplitV</span> <span class="kd">implements</span> <span class="n">bTreeVisitorI</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forBud</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">bHasFruitV</span> <span class="kd">implements</span> <span class="n">bTreeVisitorI</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forBud</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">interface</span> <span class="nc">iTreeVisitorI</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="nf">forBud</span><span class="o">();</span>
    <span class="kt">int</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">);</span>
    <span class="kt">int</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">iHeightV</span> <span class="kd">implements</span> <span class="n">iTreeVisitorI</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">forBud</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">))</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">iOccursV</span> <span class="kd">implements</span> <span class="n">iTreeVisitorI</span> <span class="o">{</span>
    <span class="n">FruitD</span> <span class="n">a</span><span class="o">;</span>
    <span class="n">iOccursV</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">_a</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_a</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">forBud</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">a</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">interface</span> <span class="nc">tTreeVisitorI</span> <span class="o">{</span>
    <span class="n">TreeD</span> <span class="nf">forBud</span><span class="o">();</span>
    <span class="n">TreeD</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">);</span>
    <span class="n">TreeD</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">tSubstV</span> <span class="kd">implements</span> <span class="n">tTreeVisitorI</span> <span class="o">{</span>
    <span class="n">FruitD</span> <span class="n">n</span><span class="o">;</span>
    <span class="n">FruitD</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">tSubstV</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">_n</span><span class="o">,</span> <span class="n">FruitD</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_n</span><span class="o">;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">TreeD</span> <span class="nf">forBud</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bud</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">TreeD</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">f</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Flat</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Flat</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">TreeD</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Split</span><span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>上面的三个接口是不是有点繁琐？那么将它合并起来。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">interface</span> <span class="nc">TreeVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">forBud</span><span class="o">();</span>
    <span class="n">Object</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">);</span>
    <span class="n">Object</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TreeD</span> <span class="o">{</span>
    <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">TreeVisitorI</span> <span class="n">ask</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bud</span> <span class="kd">extends</span> <span class="n">TreeD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">TreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forBud</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Flat</span> <span class="kd">extends</span> <span class="n">TreeD</span> <span class="o">{</span>
    <span class="n">FruitD</span> <span class="n">f</span><span class="o">;</span>
    <span class="n">TreeD</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">Flat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">_f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">_t</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">_f</span><span class="o">;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">TreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forFlat</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Split</span> <span class="kd">extends</span> <span class="n">TreeD</span> <span class="o">{</span>
    <span class="n">TreeD</span> <span class="n">l</span><span class="o">;</span>
    <span class="n">TreeD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Split</span><span class="o">(</span><span class="n">Treed</span> <span class="n">_l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">_l</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">TreeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forSplit</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">IsFlatV</span> <span class="kd">implements</span> <span class="n">TreeVisitorI</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forBud</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Boolean</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Boolean</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">bIsSplitV</span> <span class="kd">implements</span> <span class="n">bTreeVisitorI</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forBud</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Boolean</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Boolean</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(((</span><span class="n">Boolean</span><span class="o">)(</span><span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">))).</span><span class="na">booleanValue</span><span class="o">())</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Boolean</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>第七条建议</strong></p>
<p>When designing visitor protocols for</p>
<p>many different types, create a unifying</p>
<p class="last">protocol using <cite>Object</cite> .</p>
</div>
<p>但是这有一个不好的地方，如果返回的是Java的内置类型，</p>
<p>那内部在进行处理时，就要先进行转换，有时候甚至要令人发指的程度。</p>
<p>比如下面的代码：</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">OccursV</span> <span class="kd">implements</span> <span class="n">TreeVisitorI</span> <span class="o">{</span>
    <span class="n">FruitD</span> <span class="n">a</span><span class="o">;</span>
    <span class="n">iOccursV</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">_a</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_a</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forBud</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forFlat</span><span class="o">(</span><span class="n">FruitD</span> <span class="n">f</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">a</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)(</span><span class="n">t</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">))).</span><span class="na">intValue</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">forSplit</span><span class="o">(</span><span class="n">TreeD</span> <span class="n">l</span><span class="o">,</span> <span class="n">TreeD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)(</span><span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">))).</span><span class="na">intValue</span><span class="o">()</span>
                           <span class="o">+</span>
                           <span class="o">((</span><span class="n">Integer</span><span class="o">)(</span><span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">))).</span><span class="na">intValue</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="like-father-like-son">
<h2><a class="toc-backref" href="#id29">Like Father, Like Son</a><a class="headerlink" href="#like-father-like-son" title="Permalink to this headline">¶</a></h2>
<p>这一章节主要讲到了继承，从章节题目也可以看出来: 父子。</p>
<hr class="docutils" />
<p>上一章节的最后表明了一个问题：</p>
<div class="highlight-python"><div class="highlight"><pre>由于自定义类型不支持运算，只能Java的内置类型有运算功能，

所以在进行运算时，需要先转换成内置类型然后运算完后，

再转换成特定的类型。
</pre></div>
</div>
<p>为了解决这个问题，就需要定义自定义类型的相关操作方法了。</p>
<p>先实现数值类型的运算操作。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">interface</span> <span class="nc">ExprVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">forPlus</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">r</span><span class="o">);</span> <span class="c1">// 相加</span>
    <span class="n">Object</span> <span class="nf">forDiff</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">r</span><span class="o">);</span> <span class="c1">// 相减</span>
    <span class="n">Object</span> <span class="nf">forProd</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">r</span><span class="o">);</span> <span class="c1">// 相乘</span>
    <span class="n">Object</span> <span class="nf">forConst</span><span class="o">(</span><span class="n">Object</span> <span class="n">c</span><span class="o">);</span> <span class="c1">// 常量</span>
<span class="o">}</span>

<span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ExprD</span> <span class="o">{</span>
    <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ExprVisitorI</span> <span class="n">ask</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Plus</span> <span class="kd">extends</span> <span class="n">ExprD</span> <span class="o">{</span>
    <span class="n">ExprD</span> <span class="n">l</span><span class="o">;</span>
    <span class="n">ExprD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Plus</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">_l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">_l</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ExprVisitorI</span> <span class="n">ask</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forPlus</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Diff</span> <span class="kd">extends</span> <span class="n">ExprD</span> <span class="o">{</span>
    <span class="n">ExprD</span> <span class="n">l</span><span class="o">;</span>
    <span class="n">ExprD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Diff</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">_l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">_l</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ExprVisitorI</span> <span class="n">ask</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forDiff</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Prod</span> <span class="kd">extends</span> <span class="n">ExprD</span> <span class="o">{</span>
    <span class="n">ExprD</span> <span class="n">l</span><span class="o">;</span>
    <span class="n">ExprD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Prod</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">_l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">_l</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ExprVisitorI</span> <span class="n">ask</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forProd</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Const</span> <span class="kd">extends</span> <span class="n">ExprD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">c</span><span class="o">;</span>
    <span class="n">Const</span><span class="o">(</span><span class="n">Object</span> <span class="n">_c</span><span class="o">){</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_c</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ExprVisitorI</span> <span class="n">ask</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forConst</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">IntEvalV</span> <span class="kd">implements</span> <span class="n">ExprVisitorI</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forPlus</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">plus</span><span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forDiff</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">diff</span><span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forProd</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">prod</span><span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forConst</span><span class="o">(</span><span class="n">Object</span> <span class="n">c</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">plus</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">intValue</span><span class="o">()</span>
                           <span class="o">+</span>
                           <span class="o">((</span><span class="n">Integer</span><span class="o">)</span><span class="n">r</span><span class="o">).</span><span class="na">intValue</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">diff</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">intValue</span><span class="o">()</span>
                           <span class="o">-</span>
                           <span class="o">((</span><span class="n">Integer</span><span class="o">)</span><span class="n">r</span><span class="o">).</span><span class="na">intValue</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">prod</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">intValue</span><span class="o">()</span>
                           <span class="o">*</span>
                           <span class="o">((</span><span class="n">Integer</span><span class="o">)</span><span class="n">r</span><span class="o">).</span><span class="na">intValue</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>再实现，Set（集合）类型的运算操作。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SetD</span> <span class="o">{</span>
    <span class="n">SetD</span> <span class="nf">add</span><span class="o">(</span><span class="n">Integer</span> <span class="n">i</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mem</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">mem</span><span class="o">(</span><span class="n">Integer</span> <span class="n">i</span><span class="o">);</span>
    <span class="kd">abstract</span> <span class="n">SetD</span> <span class="nf">plus</span><span class="o">(</span><span class="n">SetD</span> <span class="n">s</span><span class="o">);</span>
    <span class="kd">abstract</span> <span class="n">SetD</span> <span class="nf">diff</span><span class="o">(</span><span class="n">SetD</span> <span class="n">s</span><span class="o">);</span>
    <span class="kd">abstract</span> <span class="n">SetD</span> <span class="nf">prod</span><span class="o">(</span><span class="n">SetD</span> <span class="n">s</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Empty</span> <span class="kd">extends</span> <span class="n">SetD</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">mem</span><span class="o">(</span><span class="n">Integer</span> <span class="n">i</span><span class="o">){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">SetD</span> <span class="nf">plus</span><span class="o">(</span><span class="n">SetD</span> <span class="n">s</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">SetD</span> <span class="nf">diff</span><span class="o">(</span><span class="n">SetD</span> <span class="n">s</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Empty</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">SetD</span> <span class="nf">prod</span><span class="o">(</span><span class="n">SetD</span> <span class="n">s</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Empty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Add</span> <span class="kd">extends</span> <span class="n">SetD</span> <span class="o">{</span>
    <span class="n">Integer</span> <span class="n">i</span><span class="o">;</span>
    <span class="n">SetD</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">Add</span><span class="o">(</span><span class="n">Integer</span> <span class="n">_i</span><span class="o">,</span> <span class="n">SetD</span> <span class="n">_s</span><span class="o">){</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">_i</span><span class="o">;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_s</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">mem</span><span class="o">(</span><span class="n">Integer</span> <span class="n">n</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">n</span><span class="o">))</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">mem</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">SetD</span> <span class="nf">plus</span><span class="o">(</span><span class="n">SetD</span> <span class="n">t</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">plus</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="n">SetD</span> <span class="nf">diff</span><span class="o">(</span><span class="n">SetD</span> <span class="n">t</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">mem</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">diff</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">diff</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">SetD</span> <span class="nf">prod</span><span class="o">(</span><span class="n">SetD</span> <span class="n">t</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">mem</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">prod</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">prod</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SetEvalV</span> <span class="kd">extends</span> <span class="n">IntEvalV</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">plus</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">plus</span><span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">diff</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">diff</span><span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">prod</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">prod</span><span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><cite>SetEvalV</cite> 直接继承  <cite>IntEvalV</cite> 有点不合理，好，我们改一下。</p>
<p>再抽象一个基类出来，将两者的公共代码放在基类里，然后让两者继承该基类。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">EvalD</span> <span class="kd">implements</span> <span class="n">ExprVisitorI</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forPlus</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">plus</span><span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forDiff</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">diff</span><span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forProd</span><span class="o">(</span><span class="n">ExprD</span> <span class="n">l</span><span class="o">,</span> <span class="n">ExprD</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">prod</span><span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forConst</span><span class="o">(</span><span class="n">Object</span> <span class="n">c</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">plus</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">);</span>
    <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">diff</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">);</span>
    <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">prod</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">IntEvalV</span> <span class="kd">extends</span> <span class="n">EvalD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">plus</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">intValue</span><span class="o">()</span>
                           <span class="o">+</span>
                           <span class="o">((</span><span class="n">Integer</span><span class="o">)</span><span class="n">r</span><span class="o">).</span><span class="na">intValue</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">diff</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">intValue</span><span class="o">()</span>
                           <span class="o">-</span>
                           <span class="o">((</span><span class="n">Integer</span><span class="o">)</span><span class="n">r</span><span class="o">).</span><span class="na">intValue</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">prod</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">intValue</span><span class="o">()</span>
                           <span class="o">*</span>
                           <span class="o">((</span><span class="n">Integer</span><span class="o">)</span><span class="n">r</span><span class="o">).</span><span class="na">intValue</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SetEvalV</span> <span class="kd">extends</span> <span class="n">EvalD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">plus</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">plus</span><span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">diff</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">diff</span><span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">prod</span><span class="o">(</span><span class="n">Object</span> <span class="n">l</span><span class="o">,</span> <span class="n">Object</span> <span class="n">r</span><span class="o">){</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">l</span><span class="o">).</span><span class="na">prod</span><span class="o">((</span><span class="n">SetD</span><span class="o">)</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>还记得第6章的 <cite>SubstV</cite> 和 <cite>LtdSubstV</cite> 么？</p>
<p>它们有很多相似的地方，能否采用上面的办法，合并起来？</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SubstD</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">n</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">SubstD</span><span class="o">(</span><span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_n</span><span class="o">;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SubstV</span> <span class="kd">extends</span> <span class="n">SubstD</span> <span class="o">{</span>
    <span class="n">SbustV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">_n</span><span class="o">,</span> <span class="n">_o</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">LtdSubstV</span> <span class="kd">extends</span> <span class="n">SubstD</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">c</span><span class="o">;</span>
    <span class="n">LtdSubstV</span><span class="o">(</span><span class="kt">int</span> <span class="n">_c</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">_n</span><span class="o">,</span> <span class="n">_o</span><span class="o">);</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_c</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">LtdSubstV</span><span class="o">(</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">)));</span>
            <span class="k">else</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>第八条建议</strong></p>
<p>When extending a class, use overriding</p>
<p class="last">to enrich its functionality.</p>
</div>
<p>根据以上建议， <cite>LtdSubstV</cite> 可以直接在 <cite>SubstV</cite> 类上进行继承和扩展。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">SbustV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">n</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">SubstV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_n</span><span class="o">;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">forBot</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">fotTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">LtdSubstV</span> <span class="kd">extends</span> <span class="n">SubstV</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">c</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">n</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">LtdSubstV</span><span class="o">(</span><span class="kt">int</span> <span class="n">_c</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">_n</span><span class="o">,</span> <span class="n">_o</span><span class="o">);</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_c</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">PieD</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">LtdSubstV</span><span class="o">(</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">o</span><span class="o">)));</span>
            <span class="k">else</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="be-a-good-visitor">
<h2><a class="toc-backref" href="#id30">Be a Good Visitor</a><a class="headerlink" href="#be-a-good-visitor" title="Permalink to this headline">¶</a></h2>
<p>先引入 <cite>super</cite> 关键字。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">ShadowedCartesianPt</span> <span class="n">extend</span> <span class="n">CartesianPt</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">tx</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">ty</span><span class="o">;</span>
    <span class="n">ShadowedCartesianPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_tx</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_ty</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="n">_tx</span><span class="o">;</span>
        <span class="n">ty</span> <span class="o">=</span> <span class="n">_ty</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">distanceTo0</span><span class="o">()</span>
               <span class="o">+</span>
               <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">tx</span> <span class="o">*</span> <span class="n">tx</span> <span class="o">+</span> <span class="n">ty</span> <span class="o">*</span> <span class="n">ty</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">interface</span> <span class="nc">ShapeVisitorI</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">forCircle</span><span class="o">(</span><span class="kt">int</span> <span class="n">r</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="nf">forSquare</span><span class="o">(</span><span class="kt">int</span> <span class="n">s</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="nf">forTrans</span><span class="o">(</span><span class="n">PointD</span> <span class="n">q</span><span class="o">,</span> <span class="n">ShapeD</span> <span class="n">s</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ShapeD</span> <span class="o">{</span>
    <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ShapeVisitorI</span> <span class="n">ask</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Circle</span> <span class="n">extend</span> <span class="n">ShapeD</span> <span class="o">{</span> <span class="c1">// 圆心在坐标原点的圆</span>
    <span class="kt">int</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Circle</span><span class="o">(</span><span class="kt">int</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ShapeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forCircle</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Square</span> <span class="n">extend</span> <span class="n">ShapeD</span> <span class="o">{</span> <span class="c1">//左上角在坐标原点的正方形</span>
    <span class="kt">int</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Square</span><span class="o">(</span><span class="kt">int</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ShapeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forSquare</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Trans</span> <span class="n">extend</span> <span class="n">ShapeD</span> <span class="o">{</span> <span class="c1">//在指定位置的图形，</span>
    <span class="n">PointD</span> <span class="n">q</span><span class="o">;</span>
    <span class="n">ShapeD</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">Trans</span><span class="o">(</span><span class="n">PointD</span> <span class="n">_q</span><span class="o">,</span> <span class="n">ShapeD</span> <span class="n">_s</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">_q</span><span class="o">;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_s</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ShapeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forTrans</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// 检查某个点是否在图形内部</span>
<span class="kd">class</span> <span class="nc">HasPtV</span> <span class="kd">implements</span> <span class="n">ShapeVisitorI</span> <span class="o">{</span>
    <span class="n">PointD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">HasPtV</span><span class="o">(</span><span class="n">PointD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forCircle</span><span class="o">(</span><span class="kt">int</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">distanceTo0</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forSquare</span><span class="o">(</span><span class="kt">int</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">x</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">y</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forTrans</span><span class="o">(</span><span class="n">PointD</span> <span class="n">q</span><span class="o">,</span> <span class="n">ShapeD</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">new</span> <span class="n">HasPtV</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">minus</span><span class="o">(</span><span class="n">q</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>书中说下面精彩的地方到了。</p>
<p>主要就是揭示了 <cite>interface</cite> 也能够被继承扩展，</p>
<p>和访问者模式的精华所在：兼有灵活性及扩展性。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">Union</span> <span class="kd">extends</span> <span class="n">ShapeD</span> <span class="o">{</span>
    <span class="n">ShapeD</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">ShapeD</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">Union</span><span class="o">(</span><span class="n">ShapeD</span> <span class="n">_s</span><span class="o">,</span> <span class="n">ShapeD</span> <span class="n">_t</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_s</span><span class="o">;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ShapeVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">((</span><span class="n">UnionVisitorI</span><span class="o">)</span><span class="n">ask</span><span class="o">).</span><span class="na">forUnion</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">interface</span> <span class="nc">UnionVisitorI</span> <span class="kd">extends</span> <span class="n">ShapeVisitorI</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">forUnion</span><span class="o">(</span><span class="n">ShapeD</span> <span class="n">s</span><span class="o">,</span> <span class="n">ShapeD</span> <span class="n">t</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">UnionHasPtV</span> <span class="kd">extends</span> <span class="n">HasPtV</span> <span class="kd">implements</span> <span class="n">ShapeVisitorI</span> <span class="o">{</span>
    <span class="n">UnionHasPtV</span><span class="o">(</span><span class="n">PointD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">_p</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forUnion</span><span class="o">(</span><span class="n">ShapeD</span> <span class="n">s</span><span class="o">,</span> <span class="n">ShapeD</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">||</span> <span class="n">t</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">HasPtV</span> <span class="kd">implements</span> <span class="n">ShapeVisitorI</span> <span class="o">{</span>
    <span class="n">PointD</span> <span class="n">p</span><span class="o">;</span>
    <span class="n">HasPtV</span><span class="o">(</span><span class="n">PointD</span> <span class="n">_p</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">ShapeVisitorI</span> <span class="nf">newHasPt</span><span class="o">(</span><span class="n">PointD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">HasPtV</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forCircle</span><span class="o">(</span><span class="kt">int</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">distanceTo0</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forSquare</span><span class="o">(</span><span class="kt">int</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">x</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">y</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">forTrans</span><span class="o">(</span><span class="n">PointD</span> <span class="n">q</span><span class="o">,</span> <span class="n">ShapeD</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">newHasPtV</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">minus</span><span class="o">(</span><span class="n">q</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>第九条建议</strong></p>
<p>If a datatype may have to be extended,</p>
<p>be forward looking and use a</p>
<p>constructor-like(override) method</p>
<p class="last">so that visitors can be extended too.</p>
</div>
<p>正是由于上面的提取出了 <cite>newHasPt</cite> 方法，下面直接重载即可。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UnionHasPtV</span> <span class="n">extends</span> <span class="n">HasPtV</span> <span class="n">implements</span> <span class="n">UnionVisitorI</span> <span class="p">{</span>
    <span class="n">UnionHasPtV</span><span class="p">(</span><span class="n">PointD</span> <span class="n">_p</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ShapeVisitorI</span> <span class="n">newHasPt</span><span class="p">(</span><span class="n">PointD</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">new</span> <span class="n">UnionHasPtV</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">public</span> <span class="n">boolean</span> <span class="n">forUnion</span><span class="p">(</span><span class="n">ShapeD</span> <span class="n">s</span><span class="p">,</span> <span class="n">ShapeD</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">||</span> <span class="n">t</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-state-of-things-to-come">
<h2><a class="toc-backref" href="#id31">The State of Things to Come</a><a class="headerlink" href="#the-state-of-things-to-come" title="Permalink to this headline">¶</a></h2>
<p>之前的章节每次都是生成新的实例，然后再对该实例进行操作。</p>
<p>这一章节主要讲到如果修改实例中的属性，然后再进行操作。</p>
<hr class="docutils" />
<div class="highlight-java"><div class="highlight"><pre><span class="kd">interface</span> <span class="nc">PiemanI</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="nf">addTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">);</span>
    <span class="kt">int</span> <span class="nf">remTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">);</span>
    <span class="kt">int</span> <span class="nf">substTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">);</span>
    <span class="kt">int</span> <span class="nf">occTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">PiemanM</span> <span class="kd">implements</span> <span class="n">PiemanI</span> <span class="o">{</span>
    <span class="n">PieD</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">addTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">occTop</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">remTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">PieD</span><span class="o">)</span><span class="n">p</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">new</span> <span class="n">RemV</span><span class="o">(</span><span class="n">t</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">occTop</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">substTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">PieD</span><span class="o">)</span><span class="n">p</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">new</span> <span class="n">SubstV</span><span class="o">(</span><span class="n">n</span> <span class="n">o</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">occTop</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">occTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">Integer</span><span class="o">)</span><span class="n">p</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">new</span> <span class="n">OccursV</span><span class="o">(</span><span class="n">o</span><span class="o">))).</span><span class="na">intValue</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">interface</span> <span class="nc">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">forBot</span><span class="o">();</span>
    <span class="n">Object</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PieD</span> <span class="o">{</span>
    <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">PieVisitorI</span> <span class="n">ask</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bot</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">PieVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forBot</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Top</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">PieD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Top</span><span class="o">(</span><span class="n">Object</span> <span class="n">_t</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">PieVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">OccursV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">a</span><span class="o">;</span>
    <span class="n">OccursV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_a</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_a</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forBot</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">a</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)(</span><span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">))).</span><span class="na">intValue</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SubstV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">n</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">SubstV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_n</span><span class="o">;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forBot</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="n">PieD</span><span class="o">)</span><span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="o">(</span><span class="n">PieD</span><span class="o">)</span><span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">RemV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">RemV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forBot</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span><span class="o">,</span> <span class="n">PieD</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="o">(</span><span class="n">PieD</span><span class="o">)</span><span class="n">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">interface</span> <span class="nc">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Bot</span> <span class="n">that</span><span class="o">);</span>
    <span class="n">Object</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Top</span> <span class="n">that</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PieD</span> <span class="o">{</span>
    <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">PieVisitorI</span> <span class="n">ask</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Bot</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">PieVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forBot</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Top</span> <span class="kd">extends</span> <span class="n">PieD</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">PieD</span> <span class="n">r</span><span class="o">;</span>
    <span class="n">Top</span><span class="o">(</span><span class="n">Object</span> <span class="n">_t</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span><span class="o">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_r</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">PieVisitorI</span> <span class="n">ask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ask</span><span class="o">.</span><span class="na">forTop</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">OccursV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">a</span><span class="o">;</span>
    <span class="n">OccursV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_a</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_a</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Bot</span> <span class="n">that</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Top</span> <span class="n">that</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">a</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)(</span><span class="n">that</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">))).</span><span class="na">intValue</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="n">that</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SubstV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">n</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">SubstV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_n</span><span class="o">;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Bot</span> <span class="n">that</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Top</span> <span class="n">that</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="na">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="n">PieD</span><span class="o">)(</span><span class="n">that</span><span class="o">.</span><span class="na">r</span><span class="o">).</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="na">t</span><span class="o">,</span> <span class="o">(</span><span class="n">PieD</span><span class="o">)(</span><span class="n">that</span><span class="o">.</span><span class="na">r</span><span class="o">).</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">RemV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">RemV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Bot</span> <span class="n">that</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Bot</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Top</span> <span class="n">that</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="na">t</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">that</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Top</span><span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="na">t</span><span class="o">,</span> <span class="o">(</span><span class="n">PieD</span><span class="o">)(</span><span class="n">that</span><span class="o">.</span><span class="na">r</span><span class="o">).</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>接下来，咱们通过彻底地修改实例的属性，而不是重新生成新的实例，来实现一个访问者。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">SubstV</span> <span class="kd">implements</span> <span class="n">PieVisitorI</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">n</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
    <span class="n">SubstV</span><span class="o">(</span><span class="n">Object</span> <span class="n">_n</span><span class="o">,</span> <span class="n">Object</span> <span class="n">_o</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_n</span><span class="o">;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">_o</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forBot</span><span class="o">(</span><span class="n">Bot</span> <span class="n">that</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">that</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">forTop</span><span class="o">(</span><span class="n">Top</span> <span class="n">that</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="na">t</span><span class="o">))</span>
            <span class="n">that</span><span class="o">.</span><span class="na">t</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
            <span class="n">that</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">that</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="n">that</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">that</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>第十条建议</strong></p>
<p>当必须修改一个对象时，使用一个类来隐藏修改操作，</p>
<p class="last">否则它就会对你的整个流程造成影响。</p>
</div>
<p>咱们再一个例子，加深一下理解。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PointD</span><span class="o">{</span>
    <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
    <span class="n">PointD</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_x</span><span class="o">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="nf">closerTo0</span><span class="o">(</span><span class="n">PointD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">distanceTo0</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="na">distanceTo0</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">PointD</span> <span class="nf">minus</span><span class="o">(</span><span class="n">PointD</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">CartesianPt</span><span class="o">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="na">x</span><span class="o">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="na">y</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">moveBy</span><span class="o">(</span><span class="kt">int</span> <span class="n">tx</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ty</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">tx</span><span class="o">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">ty</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">distanceTo0</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">CartesianPt</span> <span class="kd">extends</span> <span class="n">PointD</span><span class="o">{</span> <span class="c1">//笛卡尔坐标</span>
    <span class="n">CartesianPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ManhattanPt</span> <span class="kd">extends</span> <span class="n">PointD</span><span class="o">{</span> <span class="c1">//曼哈顿坐标</span>
    <span class="n">ManhattanPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">){</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ShadowedManhattanPt</span> <span class="kd">extends</span> <span class="n">ManhattanPt</span><span class="o">{</span> <span class="c1">//曼哈顿坐标</span>
    <span class="kt">int</span> <span class="n">tx</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">ty</span><span class="o">;</span>
    <span class="n">ManhattanPt</span><span class="o">(</span><span class="kt">int</span> <span class="n">_x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_tx</span><span class="o">,</span> <span class="kt">int</span> <span class="n">_ty</span><span class="o">){</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">_x</span><span class="o">,</span> <span class="n">_y</span><span class="o">);</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="n">_tx</span><span class="o">;</span>
        <span class="n">ty</span> <span class="o">=</span> <span class="n">_ty</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="nf">distanceTo0</span><span class="o">(){</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">distanceTo0</span><span class="o">()</span> <span class="o">+</span> <span class="n">tx</span> <span class="o">+</span> <span class="n">ty</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">《A Little Java, A Few Patterns》笔记</a><ul>
<li><a class="reference internal" href="#java">Java小用</a></li>
<li><a class="reference internal" href="#modern-toys">Modern Toys</a><ul>
<li><a class="reference internal" href="#seasoningd">SeasoningD</a></li>
<li><a class="reference internal" href="#pointd">PointD</a></li>
<li><a class="reference internal" href="#numd">NumD</a></li>
<li><a class="reference internal" href="#layerd">LayerD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#methods-to-our-madness">Methods to Our Madness</a><ul>
<li><a class="reference internal" href="#id1">PointD</a></li>
<li><a class="reference internal" href="#shishd">ShishD</a></li>
<li><a class="reference internal" href="#kebabd">KebabD</a></li>
<li><a class="reference internal" href="#id2">PointD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#what-s-new">What&#8217;s New?</a><ul>
<li><a class="reference internal" href="#pizzad">PizzaD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#come-to-our-carousel">Come to Our Carousel</a><ul>
<li><a class="reference internal" href="#id3">ShishD</a></li>
<li><a class="reference internal" href="#id4">PizzaD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objects-are-people-too">Objects Are People, Too</a><ul>
<li><a class="reference internal" href="#pied">PieD</a></li>
<li><a class="reference internal" href="#fishd">FishD</a></li>
<li><a class="reference internal" href="#id5">NumD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#boring-protocols">Boring Protocols</a></li>
<li><a class="reference internal" href="#oh-my">Oh My!</a></li>
<li><a class="reference internal" href="#like-father-like-son">Like Father, Like Son</a></li>
<li><a class="reference internal" href="#be-a-good-visitor">Be a Good Visitor</a></li>
<li><a class="reference internal" href="#the-state-of-things-to-come">The State of Things to Come</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/a_little_java_a_few_patterns.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="index.html">《A Little Java, A Few Patterns》笔记 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, JaunaryStar.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>